<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-2.1.1.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/globalize/0.1.1/globalize.min.js"></script>
    <script src="http://cdn3.devexpress.com/jslib/16.1.4/js/dx.all.js"></script> <!--Desktop UI widgets-->
    <link rel="stylesheet" type="text/css" href="http://cdn3.devexpress.com/jslib/16.1.4/css/dx.common.css" />
    <link rel="stylesheet" type="text/css" href="http://cdn3.devexpress.com/jslib/16.1.4/css/dx.light.css" />

    <title>DX Performance Monitor</title>

    <style>
        #chartContainer > div.progress {
            width: 100%;
            display: inline-block;
            height: 120px; 
            box-sizing: border-box;
        }
        #chartContainer > div.range {
            width: 100%;
            display: inline-block;
            height: 120px; 
            box-sizing: border-box;
        }

        #chartContainer > div {
            width: 50%;
            display: inline-block;
            height: 400px;
            box-sizing: border-box;
        }
    </style>
    <script>
		function setCookie (name, value, expires, path, domain, secure) {
			document.cookie = name + "=" + escape(value) +
				((expires) ? "; expires=" + expires.toUTCString() : "") +
				((path) ? "; path=" + path : "") +
				((domain) ? "; domain=" + domain : "") +
				((secure) ? "; secure" : "");
		}
		function getCookie(name) {
			var cookie = " " + document.cookie;
			var search = " " + name + "=";
			var setStr = "";
			var offset = 0;
			var end = 0;
			if (cookie.length > 0) {
				offset = cookie.indexOf(search);
				if (offset != -1) {
					offset += search.length;
					end = cookie.indexOf(";", offset)
					if (end == -1) {
						end = cookie.length;
					}
					setStr = unescape(cookie.substring(offset, end));
				}
			}
			return(setStr);
		}
        var getPreparedData = function (results) {
            return $.map(results, function (obj) {
                return {
                    dummy: "",
                    vendor: obj.RowKey,
                    elapsed: Math.round(obj.Elapsed * 100) / 100,
                    memory: Math.round(obj.Memory / 1024 / 1024 * 10) / 10,
                    arg: new Date(obj.PartitionKey.toString() + "Z")
                }
            });
        }
        $(document).ready(function () {
            var chartId = 0;
            var legend;
            const oneDay = 1000 * 60 * 60 * 24;
            const urlParameters = function () {
                      var query_string = {};
                      var query = window.location.search.substring(1);
                      var vars = query.split("&");
                      for (var i=0;i<vars.length;i++) {
                        var pair = vars[i].split("=");
                            // If first entry with this name
                        if (typeof query_string[pair[0]] === "undefined") {
                          query_string[pair[0]] = decodeURIComponent(pair[1]);
                            // If second entry with this name
                        } else if (typeof query_string[pair[0]] === "string") {
                          var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
                          query_string[pair[0]] = arr;
                            // If third or later entry with this name
                        } else {
                          query_string[pair[0]].push(decodeURIComponent(pair[1]));
                        }
                      } 
                      return query_string;
                    }();
            const period = parseInt(urlParameters["period"] || localStorage["dxPeriod"] || (7 * oneDay).toString());


            $.ajax({
                url: "https://dxperformance2.table.core.windows.net:443/Vendors?st=2017-03-14T06%3A28%3A00Z&se=2117-03-15T06%3A28%3A00Z&sp=r&sv=2015-12-11&tn=vendors&sig=b2HcCwCo9008iXrlU2a%2FMaRwgMM3dpEZsaGpKdAxh2w%3D",
                type: 'GET',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Accept', 'application/json;odata=nometadata');
                },
                success: function (data) {
                    legend = data.value;
                }
            });
            $.ajax({
                url: "https://dxperformance2.table.core.windows.net:443/Tests?st=2017-03-14T06%3A28%3A00Z&se=2117-03-15T06%3A28%3A00Z&sp=r&sv=2015-12-11&tn=tests&sig=ublWxOJR4v9R7AMza1SL0tvK0gwuDFZj5Zk8fkvBxmY%3D",
                type: 'GET',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Accept', 'application/json;odata=nometadata');
                },
                success: function (data) {
                    var testsList = data.value;
				
                    var keys = data.value.reduce((partitionKeys, val) => { 
                        if(partitionKeys.indexOf(val.PartitionKey) === -1)
                            partitionKeys.push(val.PartitionKey); 
                        return partitionKeys;
                    }, []);
                    $("#periodFilter").dxSelectBox({
                        displayExpr: "Value",
                        valueExpr: "Id",
                        value: period,
                        items: [ {Id: 7 * oneDay, Value: "1 Week"}, 
                                {Id: 31 * oneDay, Value: "1 Month"},
                                {Id: 186 * oneDay, Value: "6 Months"},
                                {Id: 365 * oneDay, Value: "1 Year"},
                                {Id: 2 * 365 * oneDay, Value: "2 Years"},
                                {Id: 5 * 365 * oneDay, Value: "5 Years"}],
                        onValueChanged: (e) => {
                            var x = e.value;
                            if(x != localStorage["dxPeriod"]) {
                                localStorage["dxPeriod"] = x;
                                document.location = document.location;
                            }
                        }
                    });
                    
                   
					var filter = (urlParameters["filter"] || localStorage["dxPerformanceCurrentFilter"] || "PDF").split(",").filter(function(n){ return n != "" });
                    if(!urlParameters["filter"])
                        $("#tagBoxFilter").dxTagBox({
                            items: keys,
                            showSelectionControls: true,
                            applyValueMode: "useButtons",
                            value: filter,
                            onSelectionChanged: (e) => {
                                var x = e.component.option("selectedItems").join(",");
                                if(x != localStorage["dxPerformanceCurrentFilter"]) {
                                    localStorage["dxPerformanceCurrentFilter"] = x;
                                    document.location = document.location;
                                }
                            }
                        });
                    if(urlParameters["period"])
                        $("#periodFilter").hide();
                    var $testsFilter = $("#testsFilter");
					filter = filter.map(function (str) {
						return str.replace(/\s/g, '').replace(/%20/g, '').toUpperCase();
					});
					testsList = $.map(testsList, function (test) {
						if (filter.indexOf(test.PartitionKey.toUpperCase()) > -1 || filter.indexOf(test.RowKey.replace(/\s/g, '').replace(/%20/g, '').toUpperCase()) > -1 || filter.indexOf(test.Name.replace(/\s/g, '').replace(/%20/g, '').toUpperCase()) > -1)
							return test;
						return;
					});
					$.each(testsList, function (_, testCase) {
                        var $container = $("#chartContainer");
                        var $header = $("<h1/>").text(testCase.Name).appendTo($container);
                        var $icon = $('<svg style="cursor:pointer;margin:10px" width="16" height="16" id="icon' + testCase.RowKey + '" viewBox="0 0 20 20"><path d="M16.469,8.924l-2.414,2.413c-0.156,0.156-0.408,0.156-0.564,0c-0.156-0.155-0.156-0.408,0-0.563l2.414-2.414c1.175-1.175,1.175-3.087,0-4.262c-0.57-0.569-1.326-0.883-2.132-0.883s-1.562,0.313-2.132,0.883L9.227,6.511c-1.175,1.175-1.175,3.087,0,4.263c0.288,0.288,0.624,0.511,0.997,0.662c0.204,0.083,0.303,0.315,0.22,0.52c-0.171,0.422-0.643,0.17-0.52,0.22c-0.473-0.191-0.898-0.474-1.262-0.838c-1.487-1.485-1.487-3.904,0-5.391l2.414-2.413c0.72-0.72,1.678-1.117,2.696-1.117s1.976,0.396,2.696,1.117C17.955,5.02,17.955,7.438,16.469,8.924 M10.076,7.825c-0.205-0.083-0.437,0.016-0.52,0.22c-0.083,0.205,0.016,0.437,0.22,0.52c0.374,0.151,0.709,0.374,0.997,0.662c1.176,1.176,1.176,3.088,0,4.263l-2.414,2.413c-0.569,0.569-1.326,0.883-2.131,0.883s-1.562-0.313-2.132-0.883c-1.175-1.175-1.175-3.087,0-4.262L6.51,9.227c0.156-0.155,0.156-0.408,0-0.564c-0.156-0.156-0.408-0.156-0.564,0l-2.414,2.414c-1.487,1.485-1.487,3.904,0,5.391c0.72,0.72,1.678,1.116,2.696,1.116s1.976-0.396,2.696-1.116l2.414-2.413c1.487-1.486,1.487-3.905,0-5.392C10.974,8.298,10.55,8.017,10.076,7.825"></path></svg>');
                        $icon.appendTo($header);
                        $icon.hide();
                        var $description = $("<h5/>").text(testCase.Description).appendTo($container);
                        var $timeChartContainer = $("<div class='chartCustTime' id='chartContainer" + testCase.RowKey + "'/>");
                        $timeChartContainer.appendTo($container);
                        var $memoryChartContainer = $("<div class='chartCustMem' id='memoryChartContainer" + testCase.RowKey + "'/>");
						if(testCase.HideMemoryMetrics !== true)
							$memoryChartContainer.appendTo($container);
						else
							$timeChartContainer.width('100%'); 
                        var $progress = $("<div class='progress' id='progress" + testCase.RowKey + "'/>");
                        $progress.appendTo($container);
                        var $range = $("<div class='range' id='range" + testCase.RowKey + "'/>");
                        $range.hide();
                        $range.appendTo($container);
                        $icon.on("click", function() {
                            document.location = location.protocol + '//' + location.host + location.pathname + 
                            "?filter=" + encodeURIComponent($header.text()) + 
                            "&start=" + $range.dxRangeSelector("instance").option("selectedRange").startValue + 
                            "&end=" + $range.dxRangeSelector("instance").option("selectedRange").endValue + 
                            "&period=" + period;
                        });
                        if(urlParameters["filter"]) {
                            $timeChartContainer.hide();
                            $memoryChartContainer.hide();
                        }
                    });
                    $.each(testsList, function (_, testCase) {
                        var now = new Date();
                        var newNow = new Date();
                        newNow.setDate(now.getDate() - 3);
                        var dateFormat = function (d) {
                            var month = d.getMonth() + 1;
                            if (month < 10)
                                month = '0' + month;
                            var date = d.getDate() + 1;
                            if (date < 10)
                                date = '0' + date;
                            return d.getFullYear() + '-' + month + "-" + date + 'T00:00:00';
                        };
                        $.ajax({
                            url: "https://dxperformance2.table.core.windows.net/" + testCase.RowKey + testCase.Token + "&$filter=PartitionKey+gt+'" + dateFormat(newNow) + "'&sort=-PartitionKey,RowKey",
                            type: 'GET',
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('Accept', 'application/json;odata=nometadata');
                            },
                            success: function (data) {
                                var $progressContainer = $("#progress" + testCase.RowKey);
                                $progressContainer.dxProgressBar({
                                    max: period,
                                    min: 0,
                                    value: 0
                                });
                                var startSubquery = function (skip) {
                                    var $def = $.Deferred();
                                    var newSkip = new Date(skip);
                                    newSkip.setDate(skip.getDate() - 3);
                                    $.ajax({
                                        url: "https://dxperformance2.table.core.windows.net/" + testCase.RowKey + testCase.Token +
                                             "&$filter=(PartitionKey+gt+'" + dateFormat(newSkip) + "')+and+(PartitionKey+lt+'" + dateFormat(skip) + "')&sort=-PartitionKey,RowKey",
                                        type: 'GET',
                                        beforeSend: function (xhr) {
                                            xhr.setRequestHeader('Accept', 'application/json;odata=nometadata');
                                        },
                                        success: function (data) {
                                            var results = data.value;
                                            var progressValue = (new Date() - newSkip);
                                            $("#progress" + testCase.RowKey).dxProgressBar("instance").option("value", progressValue);
                                            if (progressValue < period) {
                                                startSubquery(newSkip).then(function (subqueryResults) {
                                                    $def.resolve(subqueryResults.concat(results));
                                                });
                                            } else {
                                                var $timeChartContainer = $("#chartContainer" + testCase.RowKey);
                                                var $memoryChartContainer = $("#memoryChartContainer" + testCase.RowKey);
                                                $timeChartContainer.show();
                                                $memoryChartContainer.show();
                                                $("#progress" + testCase.RowKey).hide();
                                                $("#range" + testCase.RowKey).show();
                                                if(!urlParameters["filter"])
                                                $("#icon" + testCase.RowKey).show();

                                                $def.resolve(results);
                                                return;
                                            }
                                        }
                                    });
                                    return $def;
                                }
                                startSubquery(newNow).then(function (result) {
                                    testCase.data = getPreparedData(result).concat(testCase.data);
                                    $timeChartContainer.dxChart("option", "needRealData", true);
                                    var rangeSelector = $rangeChartContainer.dxRangeSelector("instance");
                                    var original = rangeSelector.getSelectedRange(),
                                        originalHandler = rangeSelector.option("onSelectedRangeChanged");
                                    var updateRange = urlParameters["period"] || period > 8 * oneDay;
                                    if (!updateRange)
                                        rangeSelector.option("onSelectedRangeChanged", null)
                                    rangeSelector.option("dataSource", testCase.data);
                                    if (!updateRange)
                                        rangeSelector.setSelectedRange(original);
                                    if(urlParameters["start"] && urlParameters["end"]) {
                                        rangeSelector.setSelectedRange({
                                            startValue: urlParameters["start"],
                                            endValue: urlParameters["end"]
                                        });
                                    }
                                    rangeSelector.option("onSelectedRangeChanged", originalHandler)
                                    window.range = $rangeChartContainer.dxRangeSelector("instance");
                                });
                                testCase.data = getPreparedData(data.value);
                                var legendCustomization = function () {
                                    var sn = this.seriesName;
                                    for (var i = -1, j = legend.length; ++i < j;)
                                        if (legend[i].RowKey == sn)
                                            return legend[i].Title;
                                    return this.seriesName;
                                };
                                var seriesCustomization = function (valueFromNameField) {
                                    for (var i = -1, j = legend.length; ++i < j;)
                                        if (legend[i].RowKey == valueFromNameField)
                                            return { color: legend[i].Color };
                                    return { color: "gray" };
                                };
                                var toolTipCustomization = function (point) {
                                    var dt = point.argument;
                                    return { text: point.valueText + "\r\n" + (dt.getMonth() + 1) + "/" + dt.getDate() + " " + dt.getHours() + ":" + dt.getMinutes() };
                                };
								var legendClickHandler = function (info) {
									var series = info.target;
									var chart = $("#chartContainer" + testCase.RowKey).dxChart('instance');
									var series2 = chart.getSeriesByName(series.name);

									if (series.isVisible()) {
										series.hide();
										series2.hide();
									} else {
										series.show();
										series2.show();
									}
								};
								var seriesHoverChangedHandler = function (info) {
									var hoveredSeries = info.target,
										chart = $("#chartContainer" + testCase.RowKey).dxChart('instance'),
										series = chart.getSeriesByName(hoveredSeries.name);
									if (hoveredSeries.isHovered() && series) {
										chart._tracker._setHoveredSeries(series, 'includePoints');
									} else {
										chart._tracker._releaseHoveredSeries();
									}
								};
                                var $timeChartContainer = $("#chartContainer" + testCase.RowKey);
                                $timeChartContainer.dxChart({
                                    dataSource: testCase.data,
                                    useAggregation: true,
                                    commonSeriesSettings: {
                                        valueField: "elapsed",
                                        point: {
                                            size: 3
                                        }
                                    },
                                    valueAxis: [{
                                        title: {
                                            text: "Seconds"
                                        }
                                    }],
                                    argumentAxis: { valueMarginsEnabled: false },
                                    seriesTemplate: {
                                        nameField: "vendor",
                                        customizeSeries: seriesCustomization
                                    },
                                    legend: {
										customizeText: legendCustomization,
										visible: testCase.HideMemoryMetrics === true },
                                    animation: false,
                                    tooltip: {
                                        enabled: true,
                                        customizeTooltip: toolTipCustomization
                                    },
                                    useAggregation: true,
                                    //onSeriesHoverChanged: seriesHoverChangedHandler,
									onLegendClick: legendClickHandler
                                });

                                var $memoryChartContainer = $("#memoryChartContainer" + testCase.RowKey);
                                $memoryChartContainer.dxChart({
                                    dataSource: testCase.data,
                                    commonSeriesSettings: {
                                        valueField: "memory",
                                        point: {
                                            size: 3
                                        }
                                    },
                                    valueAxis: [{ 
                                        title: {
                                            text: "Memory (Mbytes)"
                                        }
                                    }],
                                    argumentAxis: { valueMarginsEnabled: false },
                                    seriesTemplate: {
                                        nameField: "vendor",
                                        customizeSeries: seriesCustomization
                                    },
                                    legend: { customizeText: legendCustomization },
                                    animation: false,
                                    tooltip: {
                                        enabled: true,
                                        customizeTooltip: toolTipCustomization
                                    },
                                    useAggregation: true,
                                    onSeriesHoverChanged: seriesHoverChangedHandler,
                                    onLegendClick: legendClickHandler
                                });
                                var hv = testCase.HideVendor;
                                if (hv) {
                                    hv = hv.split(',');
                                    $.each(hv, function (_, name) {
                                        var tchart = $timeChartContainer.dxChart('instance');
                                        var mchart = $memoryChartContainer.dxChart('instance');
                                        var series = tchart.getSeriesByName(name);
                                        if (series)
                                            series.hide();
                                        var series = mchart.getSeriesByName(name);
                                        if (series)
                                            series.hide();
                                    });
                                }
                                var $rangeChartContainer = $("#range" + testCase.RowKey);
                                $rangeChartContainer.dxRangeSelector({
                                    size: {
                                        height: 120
                                    },
                                    dataSource: testCase.data,
                                    chart: {
                                        useAggregation: true,
                                        series: [{
                                            argumentField: 'arg',
                                            valueField: 'dummy'
                                        }]
                                    },
                                    behavior: {
                                        callSelectedRangeChanged: "onMoving"
                                    },
                                    onSelectedRangeChanged: function (e) {
                                        var memoryChart = $memoryChartContainer.dxChart("instance"),
                                            timeChart = $timeChartContainer.dxChart("instance");
                                        if (timeChart.option("needRealData")) {
                                            console.log("Data update happens");
											if(memoryChart)
												memoryChart.option("dataSource", testCase.data);
                                            timeChart.option("dataSource", testCase.data);
                                            timeChart.option("needRealData", false);
                                        }
										if(memoryChart)
											memoryChart.zoomArgument(e.startValue, e.endValue);
                                        timeChart.zoomArgument(e.startValue, e.endValue);
                                    }
                                });
                            }
                        });
                    });
                },
                error: function (rcvData) {
                    console.log(rcvData);
                }
            });
        });
    </script>
</head>
<body>
	<div id="testsFilter"></div>
    <div style="display:flex">
        <div id="periodFilter" style="width:200px"></div>
        <div id="tagBoxFilter" style="flex:1"></div>
    </div>
    <div id="chartContainer" style="width: 100%; height:400px;">
    </div>
</body>
</html>